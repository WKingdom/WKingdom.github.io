<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Roboto-Black:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android,系统源码," />










<meta name="description" content="分屏启动桌面入口部分桌面点击这个Split top按钮的onClick后触发自己进程的view相关的动画，对应堆栈： 1234567891011121314151617181920212223at com.android.quickstep.views.RecentsView.createInitialSplitSelectAnimation(RecentsView.java:2769)at co">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 13 WMS分屏流程">
<meta property="og:url" content="http://yoursite.com/2023/09/21/FW%20WMS%E5%88%86%E5%B1%8F%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="WZKingdom-个人博客">
<meta property="og:description" content="分屏启动桌面入口部分桌面点击这个Split top按钮的onClick后触发自己进程的view相关的动画，对应堆栈： 1234567891011121314151617181920212223at com.android.quickstep.views.RecentsView.createInitialSplitSelectAnimation(RecentsView.java:2769)at co">
<meta property="article:published_time" content="2023-09-20T18:26:43.000Z">
<meta property="article:modified_time" content="2024-11-10T23:42:55.641Z">
<meta property="article:author" content="WZKingdom">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="系统源码">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2023/09/21/FW WMS分屏流程/"/>





  <title>Android 13 WMS分屏流程 | WZKingdom-个人博客</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
		<a href="https://github.com/WKingdom" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WZKingdom-个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">那些疯狂到以为自己能够改变世界的人，才能真正改变世界。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    


  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/09/21/FW%20WMS%E5%88%86%E5%B1%8F%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WZKingdom">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WZKingdom-个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android 13 WMS分屏流程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-09-21T02:26:43+08:00">
                2023-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81/" itemprop="url" rel="index">
                    <span itemprop="name">系统源码</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6.4k
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="分屏启动"><a href="#分屏启动" class="headerlink" title="分屏启动"></a>分屏启动</h4><h5 id="桌面入口部分"><a href="#桌面入口部分" class="headerlink" title="桌面入口部分"></a>桌面入口部分</h5><p>桌面点击这个Split top按钮的onClick后触发自己进程的view相关的动画，对应堆栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">at com.android.quickstep.views.RecentsView.createInitialSplitSelectAnimation(RecentsView.java:2769)</span><br><span class="line">at com.android.quickstep.views.RecentsView.createTaskDismissAnimation(RecentsView.java:2976)</span><br><span class="line">at com.android.quickstep.views.RecentsView.createSplitSelectInitAnimation(RecentsView.java:4023)</span><br><span class="line">at com.android.launcher3.uioverrides.RecentsViewStateController.handleSplitSelectionState(RecentsViewStateController.java:120)</span><br><span class="line">at com.android.launcher3.uioverrides.RecentsViewStateController.setStateWithAnimationInternal(RecentsViewStateController.java:96)</span><br><span class="line">at com.android.launcher3.uioverrides.BaseRecentsViewStateController.setStateWithAnimation(BaseRecentsViewStateController.java:87)</span><br><span class="line">at com.android.launcher3.uioverrides.BaseRecentsViewStateController.setStateWithAnimation(BaseRecentsViewStateController.java:53)</span><br><span class="line">at com.android.launcher3.statemanager.StateManager.createAnimationToNewWorkspaceInternal(StateManager.java:324)</span><br><span class="line">at com.android.launcher3.statemanager.StateManager.goToStateAnimated(StateManager.java:259)</span><br><span class="line">at com.android.launcher3.statemanager.StateManager.goToState(StateManager.java:247)</span><br><span class="line">at com.android.launcher3.statemanager.StateManager.goToState(StateManager.java:150)</span><br><span class="line">at com.android.launcher3.statemanager.StateManager.goToState(StateManager.java:143)</span><br><span class="line">at com.android.quickstep.views.LauncherRecentsView.initiateSplitSelect(LauncherRecentsView.java:182)</span><br><span class="line">at com.android.quickstep.views.TaskView.initiateSplitSelect(TaskView.java:1541)</span><br><span class="line">at com.android.quickstep.TaskShortcutFactory$SplitSelectSystemShortcut.onClick(TaskShortcutFactory.java:132)</span><br><span class="line">at com.android.quickstep.views.TaskMenuView.lambda$addMenuOption$1(TaskMenuView.java:254)</span><br><span class="line">at com.android.quickstep.views.TaskMenuView$$ExternalSyntheticLambda2.run(Unknown Source:4)</span><br><span class="line">at com.android.quickstep.views.RecentsView.finishRecentsAnimation(RecentsView.java:4536)</span><br><span class="line">at com.android.quickstep.views.TaskMenuView.lambda$addMenuOption$2(TaskMenuView.java:252)</span><br><span class="line">at com.android.quickstep.views.TaskMenuView$$ExternalSyntheticLambda1.run(Unknown Source:6)</span><br><span class="line">at com.android.quickstep.views.RecentsView.switchToScreenshot(RecentsView.java:4962)</span><br><span class="line">at com.android.quickstep.views.TaskMenuView.lambda$addMenuOption$3$com-android-quickstep-views-TaskMenuView(TaskMenuView.java:251)</span><br><span class="line">at com.android.quickstep.views.TaskMenuView$$ExternalSyntheticLambda5.onClick(Unknown Source:4)</span><br></pre></td></tr></table></figure>

<p>点击之后会有相关动画的准备工作：<br>比如选择短信，短信app会放到上面，下面多任务依旧是多任务，但是位置发生了变化。</p>
<p>createInitialSplitSelectAnimation是上面那个短信应用上半屏幕部分显示的动画构建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Places an &#123;<span class="doctag">@link</span> FloatingTaskView&#125; on top of the thumbnail for &#123;<span class="doctag">@link</span> #mSplitHiddenTaskView&#125;</span></span><br><span class="line"><span class="comment">     * and then animates it into the split position that was desired</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createInitialSplitSelectAnimation</span><span class="params">(PendingAnimation anim)</span> </span>&#123;</span><br><span class="line">        mOrientationHandler.getInitialSplitPlaceholderBounds(mSplitPlaceholderSize,</span><br><span class="line">                mSplitPlaceholderInset, mActivity.getDeviceProfile(),</span><br><span class="line">                mSplitSelectStateController.getActiveSplitStagePosition(), mTempRect);</span><br><span class="line"></span><br><span class="line">        RectF startingTaskRect = <span class="keyword">new</span> RectF();</span><br><span class="line">        <span class="keyword">if</span> (mSplitHiddenTaskView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSplitHiddenTaskView.setVisibility(INVISIBLE);<span class="comment">//把TaskView设置不可见</span></span><br><span class="line">            <span class="comment">//要创建一个TaskView的副本，并且要把这个副本进行相关的动画播放显示在最顶端一个小区域</span></span><br><span class="line">            mFirstFloatingTaskView = FloatingTaskView.getFloatingTaskView(mActivity,</span><br><span class="line">                    mSplitHiddenTaskView.getThumbnail(),</span><br><span class="line">                    mSplitHiddenTaskView.getThumbnail().getThumbnail(),</span><br><span class="line">                    mSplitHiddenTaskView.getIconView().getDrawable(), startingTaskRect);</span><br><span class="line">            mFirstFloatingTaskView.setAlpha(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//根据相关的初始化尺寸来构建对应anim</span></span><br><span class="line">            mFirstFloatingTaskView.addAnimation(anim, startingTaskRect, mTempRect,</span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">/* fadeWithThumbnail */</span>, <span class="keyword">true</span> <span class="comment">/* isStagedTask */</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         </span><br><span class="line">        &#125;</span><br><span class="line">        anim.addEndListener(success -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                mSplitToast.show();</span><br><span class="line">                <span class="comment">//动画播放完成后，显示出一个Toast "点按另一个应用即可使用分屏"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>此时分屏在桌面多任务完成了第一步，把TaskView放到顶部，接下来要手动选择一个下屏app，才可以构成真正意义的分屏。</p>
<p>底部点击TaskView触发动画流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (confirmSecondSplitSelectApp()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      	launchTasks();</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">confirmSecondSplitSelectApp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = getChildTaskIndexAtPosition(mLastTouchDownPosition);</span><br><span class="line">        TaskIdAttributeContainer container = mTaskIdAttributeContainer[index];</span><br><span class="line">        <span class="comment">//调用到了RecentsView的confirmSplitSelect方法</span></span><br><span class="line">        <span class="keyword">return</span> getRecentsView().confirmSplitSelect(<span class="keyword">this</span>, container.getTask(),</span><br><span class="line">                container.getIconView(), container.getThumbnailView());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//RecentsView.java</span></span><br><span class="line">	<span class="comment">//方法进行相关的动画准备和启动</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">confirmSplitSelect</span><span class="params">(TaskView containerTaskView, Task task, IconView iconView,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskThumbnailView thumbnailView)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        mSplitSelectStateController.setSecondTask(task);<span class="comment">//设置底部区域要显示的task</span></span><br><span class="line">        RectF secondTaskStartingBounds = <span class="keyword">new</span> RectF();<span class="comment">//初始化底部的区域</span></span><br><span class="line">        Rect secondTaskEndingBounds = <span class="keyword">new</span> Rect();</span><br><span class="line">        Rect firstTaskStartingBounds = <span class="keyword">new</span> Rect();<span class="comment">//初始化顶部的区域</span></span><br><span class="line">        Rect firstTaskEndingBounds = mTempRect;</span><br><span class="line">        <span class="comment">//获取动画时间</span></span><br><span class="line">        <span class="keyword">int</span> duration = mActivity.getStateManager().getState().getTransitionDuration(mActivity,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* isToState */</span>);</span><br><span class="line">        PendingAnimation pendingAnimation = <span class="keyword">new</span> PendingAnimation(duration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> halfDividerSize = getResources()</span><br><span class="line">                .getDimensionPixelSize(R.dimen.multi_window_task_divider_size) / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">//获取对应的一个上屏幕区域和下屏幕区域截至区域firstTaskEndingBounds，secondTaskEndingBounds</span></span><br><span class="line">        mOrientationHandler.getFinalSplitPlaceholderBounds(halfDividerSize,</span><br><span class="line">                mActivity.getDeviceProfile(),</span><br><span class="line">                mSplitSelectStateController.getActiveSplitStagePosition(), firstTaskEndingBounds,</span><br><span class="line">                secondTaskEndingBounds);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//获取当前的上屏幕区域坐标情况放入firstTaskStartingBounds</span></span><br><span class="line">        mFirstFloatingTaskView.getBoundsOnScreen(firstTaskStartingBounds);</span><br><span class="line">        <span class="comment">//有了初始区域和结束区域，进行相关的动画配置</span></span><br><span class="line">        mFirstFloatingTaskView.addAnimation(pendingAnimation,</span><br><span class="line">                <span class="keyword">new</span> RectF(firstTaskStartingBounds), firstTaskEndingBounds,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* fadeWithThumbnail */</span>, <span class="keyword">true</span> <span class="comment">/* isStagedTask */</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//下屏部分</span></span><br><span class="line">        mSecondFloatingTaskView = FloatingTaskView.getFloatingTaskView(mActivity,</span><br><span class="line">                thumbnailView, thumbnailView.getThumbnail(),</span><br><span class="line">                iconView.getDrawable(), secondTaskStartingBounds);</span><br><span class="line">        mSecondFloatingTaskView.setAlpha(<span class="number">1</span>);</span><br><span class="line">        mSecondFloatingTaskView.addAnimation(pendingAnimation, secondTaskStartingBounds,</span><br><span class="line">                secondTaskEndingBounds, <span class="keyword">true</span> <span class="comment">/* fadeWithThumbnail */</span>, <span class="keyword">false</span> <span class="comment">/* isStagedTask */</span>);</span><br><span class="line">          <span class="comment">//进行动画结束监听，在动画结束时候才进行launchSplitTasks，正式调用到systemui启动真正分屏</span></span><br><span class="line">        pendingAnimation.addEndListener(aBoolean -&gt; &#123;</span><br><span class="line">            mSplitSelectStateController.launchSplitTasks(</span><br><span class="line">                    aBoolean1 -&gt; RecentsView.<span class="keyword">this</span>.resetFromSplitSelectionState());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (containerTaskView.containsMultipleTasks()) &#123;</span><br><span class="line">            <span class="comment">// If we are launching from a child task, then only hide the thumbnail itself</span></span><br><span class="line">            mSecondSplitHiddenView = thumbnailView;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSecondSplitHiddenView = containerTaskView;</span><br><span class="line">        &#125;</span><br><span class="line">        mSecondSplitHiddenView.setVisibility(INVISIBLE);<span class="comment">//下屏的TaskView要被隐藏</span></span><br><span class="line">        pendingAnimation.buildAnim().start();<span class="comment">//启动正式动画</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>动画结束后执行mSplitSelectStateController.launchSplitTasks，正式调用systemui相关的shell接口进行操作真正的task相关分屏业务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">at com.android.quickstep.SystemUiProxy.startTasksWithLegacyTransition(SystemUiProxy.java:621)</span><br><span class="line">                                                                                                    	at com.android.quickstep.util.SplitSelectStateController.launchTasks(SplitSelectStateController.java:201)</span><br><span class="line">                                                                                                    	at com.android.quickstep.util.SplitSelectStateController.launchSplitTasks(SplitSelectStateController.java:124)</span><br><span class="line">                                                                                                    	at com.android.quickstep.views.RecentsView.lambda$confirmSplitSelect$24$com-android-quickstep-views-RecentsView(RecentsView.java:4082)</span><br></pre></td></tr></table></figure>

<h5 id="SystemUI部分"><a href="#SystemUI部分" class="headerlink" title="SystemUI部分"></a>SystemUI部分</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;SystemUiProxy.java</span><br><span class="line">private ISplitScreen mSplitScreen;</span><br><span class="line"> public void startTasksWithLegacyTransition(int mainTaskId, Bundle mainOptions, int sideTaskId,</span><br><span class="line">           Bundle sideOptions, @SplitConfigurationOptions.StagePosition int sidePosition,</span><br><span class="line">           float splitRatio, RemoteAnimationAdapter adapter) &#123;</span><br><span class="line">       mSplitScreen.startTasksWithLegacyTransition(mainTaskId, mainOptions, sideTaskId,</span><br><span class="line">                       sideOptions, sidePosition, splitRatio, adapter);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>mSplitScreen是ISplitScreen  Binder接口,会调用到SystemUI所在的服务端<br>这里对应SystemUI端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//frameworks/base/libs/WindowManager/Shell/src/com/android/wm/shell/splitscreen/SplitScreenController.java</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ISplitScreenImpl</span> <span class="keyword">extends</span> <span class="title">ISplitScreen</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startTasksWithLegacyTransition</span><span class="params">(<span class="keyword">int</span> mainTaskId, @Nullable Bundle mainOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> sideTaskId, @Nullable Bundle sideOptions, @SplitPosition <span class="keyword">int</span> sidePosition,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">float</span> splitRatio, RemoteAnimationAdapter adapter)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//注意这里有线程切换哈，binder线程到main线程</span></span><br><span class="line">            executeRemoteCallWithTaskPermission(mController, <span class="string">"startTasks"</span>,</span><br><span class="line">                    (controller) -&gt; controller.mStageCoordinator.startTasksWithLegacyTransition(</span><br><span class="line">                            mainTaskId, mainOptions, sideTaskId, sideOptions, sidePosition,</span><br><span class="line">                            splitRatio, adapter));</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//frameworks/base/libs/WindowManager/Shell/src/com/android/wm/shell/splitscreen/StageCoordinator.java</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startWithLegacyTransition</span><span class="params">(<span class="keyword">int</span> mainTaskId, <span class="keyword">int</span> sideTaskId,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable PendingIntent pendingIntent, @Nullable Intent fillInIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Bundle mainOptions, @Nullable Bundle sideOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">            @SplitPosition <span class="keyword">int</span> sidePosition, <span class="keyword">float</span> splitRatio, RemoteAnimationAdapter adapter)</span> </span>&#123;</span><br><span class="line">     	<span class="comment">//1、初始化分屏的分割线的布局</span></span><br><span class="line">        mSplitLayout.init();</span><br><span class="line">    	<span class="comment">//初始化用来跨进程传递的WindowContainerTransaction</span></span><br><span class="line">        <span class="keyword">final</span> WindowContainerTransaction wct = <span class="keyword">new</span> WindowContainerTransaction();</span><br><span class="line">    </span><br><span class="line">   		<span class="comment">//初始化一个远程动画的运行回调binder对象</span></span><br><span class="line">        IRemoteAnimationRunner wrapper = <span class="keyword">new</span> IRemoteAnimationRunner.Stub() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(@WindowManager.TransitionOldType <span class="keyword">int</span> transit,</span></span></span><br><span class="line"><span class="function"><span class="params">                    RemoteAnimationTarget[] apps,</span></span></span><br><span class="line"><span class="function"><span class="params">                    RemoteAnimationTarget[] wallpapers,</span></span></span><br><span class="line"><span class="function"><span class="params">                    RemoteAnimationTarget[] nonApps,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">final</span> IRemoteAnimationFinishedCallback finishedCallback)</span> </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//包装一下成为RemoteAnimationAdapter类型</span></span><br><span class="line">        RemoteAnimationAdapter wrappedAdapter = <span class="keyword">new</span> RemoteAnimationAdapter(</span><br><span class="line">                wrapper, adapter.getDuration(), adapter.getStatusBarTransitionDelay());</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//构建出对应的mainOptions，及上分屏的启动option</span></span><br><span class="line">         mainOptions = mainActivityOptions.toBundle();</span><br><span class="line"> 		<span class="comment">//准备好对应的sideOptions，下分屏的option</span></span><br><span class="line">        sideOptions = sideOptions != <span class="keyword">null</span> ? sideOptions : <span class="keyword">new</span> Bundle();</span><br><span class="line">        setSideStagePosition(sidePosition, wct);</span><br><span class="line">		<span class="comment">//设置分界线比例，一般大小上下屏幕都一样大，为0.5，这里就把对应的上下分屏的bound计算出来了</span></span><br><span class="line">        mSplitLayout.setDivideRatio(splitRatio);</span><br><span class="line">        <span class="keyword">if</span> (!mMainStage.isActive()) &#123;<span class="comment">//设置为active</span></span><br><span class="line">            mMainStage.activate(wct, <span class="keyword">false</span> <span class="comment">/* reparent */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//把计算出来的上下分屏的bound都设置给对应的configration，传递到systemserver端，然后systemserver更新task的bound</span></span><br><span class="line">        updateWindowBounds(mSplitLayout, wct);</span><br><span class="line">        <span class="comment">//2、需要让装载分屏的roottask进行reorder，主要就是为了把分屏移到最前面, 注意这里的mRootTaskInfo其实就是一开始SystemUI负责创建的mutilwindow的task</span></span><br><span class="line">        wct.reorder(mRootTaskInfo.token, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//准备好对应的option参数</span></span><br><span class="line">        <span class="comment">// Make sure the launch options will put tasks in the corresponding split roots</span></span><br><span class="line">        addActivityOptions(mainOptions, mMainStage);</span><br><span class="line">        addActivityOptions(sideOptions, mSideStage);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//3、分别准备好对应上下分屏启动task的transition</span></span><br><span class="line">        <span class="comment">// Add task launch requests</span></span><br><span class="line">        wct.startTask(mainTaskId, mainOptions);</span><br><span class="line">        <span class="keyword">if</span> (withIntent) &#123;</span><br><span class="line">            wct.sendPendingIntent(pendingIntent, fillInIntent, sideOptions);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wct.startTask(sideTaskId, sideOptions);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//最后把前面准备好的WindowContainerTranstion统一进行apply到systemserver</span></span><br><span class="line">        <span class="comment">// Using legacy transitions, so we can't use blast sync since it conflicts.</span></span><br><span class="line">        mTaskOrganizer.applyTransaction(wct);</span><br><span class="line">        mSyncQueue.runInSync(t -&gt; &#123;</span><br><span class="line">        	<span class="comment">//这里主要进行相关的divider分界线显示</span></span><br><span class="line">            setDividerVisibility(<span class="keyword">true</span>, t);</span><br><span class="line">            updateSurfaceBounds(mSplitLayout, t, <span class="keyword">false</span> <span class="comment">/* applyResizingOffset */</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>mMainStage和mSideStage属于和RootTask一样，分屏的RootTask一般会带两个子task，分别是mMainStage和mSideStage的RootTaskInfo。</p>
<p>上面注释中的代码主要做了下面几件事情：</p>
<ol>
<li>分割线初始化和上下分屏的区域参数</li>
<li>分屏的RootTask进行reorder，移到最前面</li>
<li>上下分屏执行startTask</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//SplitLayout的init</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mInitialized) <span class="keyword">return</span>;</span><br><span class="line">        mInitialized = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//调用mSplitWindowManager初始化，主要是创建对应window出来,不是用普通的windowmanager创建的，dumpsys window windows是看不到的，通过dumpsys SurfaceFlinger可以看到</span></span><br><span class="line">        mSplitWindowManager.init(<span class="keyword">this</span>, mInsetsState);</span><br><span class="line">        mDisplayImeController.addPositionProcessor(mImePositionProcessor);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//SplitWindowManager的init</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(SplitLayout splitLayout, InsetsState insetsState)</span> </span>&#123;</span><br><span class="line">        mViewHost = <span class="keyword">new</span> SurfaceControlViewHost(mContext, mContext.getDisplay(), <span class="keyword">this</span>);</span><br><span class="line">        mDividerView = (DividerView) LayoutInflater.from(mContext)</span><br><span class="line">                .inflate(R.layout.split_divider, <span class="keyword">null</span> <span class="comment">/* root */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Rect dividerBounds = splitLayout.getDividerBounds();</span><br><span class="line">        WindowManager.LayoutParams lp = <span class="keyword">new</span> WindowManager.LayoutParams(</span><br><span class="line">                dividerBounds.width(), dividerBounds.height(), TYPE_DOCK_DIVIDER,</span><br><span class="line">                FLAG_NOT_FOCUSABLE | FLAG_NOT_TOUCH_MODAL | FLAG_WATCH_OUTSIDE_TOUCH</span><br><span class="line">                        | FLAG_SPLIT_TOUCH | FLAG_SLIPPERY,</span><br><span class="line">                PixelFormat.TRANSLUCENT);</span><br><span class="line">        lp.token = <span class="keyword">new</span> Binder();</span><br><span class="line">        lp.setTitle(mWindowName);</span><br><span class="line">        lp.privateFlags |= PRIVATE_FLAG_NO_MOVE_ANIMATION | PRIVATE_FLAG_TRUSTED_OVERLAY;</span><br><span class="line">        mViewHost.setView(mDividerView, lp);</span><br><span class="line">        mDividerView.setup(splitLayout, <span class="keyword">this</span>, mViewHost, insetsState);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>区域的计算确定部分，setDivideRatio方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDivideRatio</span><span class="params">(<span class="keyword">float</span> ratio)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//这里的position是非常关键，这个是roottask上下屏幕相等情况</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> position = isLandscape()</span><br><span class="line">            ? mRootBounds.left + (<span class="keyword">int</span>) (mRootBounds.width() * ratio)</span><br><span class="line">            : mRootBounds.top + (<span class="keyword">int</span>) (mRootBounds.height() * ratio);</span><br><span class="line">    <span class="keyword">final</span> DividerSnapAlgorithm.SnapTarget snapTarget =</span><br><span class="line">            mDividerSnapAlgorithm.calculateNonDismissingSnapTarget(position);</span><br><span class="line">    <span class="comment">//设置对应的位置position，非常关键会触发bound的计算</span></span><br><span class="line">    setDividePosition(snapTarget.position, <span class="keyword">false</span> <span class="comment">/* applyLayoutChange */</span>);</span><br><span class="line">&#125;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">setDividePosition</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span> applyLayoutChange)</span> </span>&#123;</span><br><span class="line">        mDividePosition = position;</span><br><span class="line">       <span class="comment">//根据新新的mDividePosition计算新的bound</span></span><br><span class="line">        updateBounds(mDividePosition);</span><br><span class="line">        <span class="keyword">if</span> (applyLayoutChange) &#123;</span><br><span class="line">            mSplitLayoutHandler.onLayoutSizeChanged(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">       <span class="comment">/** Updates recording bounds of divider window and both of the splits. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateBounds</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        mDividerBounds.set(mRootBounds);</span><br><span class="line">        mBounds1.set(mRootBounds);</span><br><span class="line">        mBounds2.set(mRootBounds);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isLandscape = isLandscape(mRootBounds);</span><br><span class="line">        <span class="keyword">if</span> (isLandscape) &#123;</span><br><span class="line">            position += mRootBounds.left;</span><br><span class="line">            mDividerBounds.left = position - mDividerInsets;</span><br><span class="line">            mDividerBounds.right = mDividerBounds.left + mDividerWindowWidth;</span><br><span class="line">            mBounds1.right = position;</span><br><span class="line">            mBounds2.left = mBounds1.right + mDividerSize;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            position += mRootBounds.top;</span><br><span class="line">            mDividerBounds.top = position - mDividerInsets;</span><br><span class="line">            mDividerBounds.bottom = mDividerBounds.top + mDividerWindowWidth;</span><br><span class="line">            mBounds1.bottom = position;</span><br><span class="line">            mBounds2.top = mBounds1.bottom + mDividerSize;</span><br><span class="line">        &#125;</span><br><span class="line">        DockedDividerUtils.sanitizeStackBounds(mBounds1, <span class="keyword">true</span> <span class="comment">/** topLeft */</span>);</span><br><span class="line">        DockedDividerUtils.sanitizeStackBounds(mBounds2, <span class="keyword">false</span> <span class="comment">/** topLeft */</span>);</span><br><span class="line">        mSurfaceEffectPolicy.applyDividerPosition(position, isLandscape);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>已经计算好了分屏的bound后，需要把bound设置到WindowContainerTransition中进行传递：</p>
<p>updateWindowBounds(mSplitLayout, wct);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateWindowBounds</span><span class="params">(SplitLayout layout, WindowContainerTransaction wct)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> StageTaskListener topLeftStage =</span><br><span class="line">            mSideStagePosition == SPLIT_POSITION_TOP_OR_LEFT ? mSideStage : mMainStage;</span><br><span class="line">    <span class="keyword">final</span> StageTaskListener bottomRightStage =</span><br><span class="line">            mSideStagePosition == SPLIT_POSITION_TOP_OR_LEFT ? mMainStage : mSideStage;</span><br><span class="line">    <span class="comment">//分别有了上下屏task信息后，要对这些task的bound进行修改，applyTaskChanges就是关键的方法（这里的task还不是直接app的task，还是分屏的mMainStage及mSideStage对应的容器task）</span></span><br><span class="line">    layout.applyTaskChanges(wct, topLeftStage.mRootTaskInfo, bottomRightStage.mRootTaskInfo);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">/** Apply recorded task layout to the &#123;<span class="doctag">@link</span> WindowContainerTransaction&#125;. */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyTaskChanges</span><span class="params">(WindowContainerTransaction wct,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityManager.RunningTaskInfo task1, ActivityManager.RunningTaskInfo task2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mBounds1.equals(mWinBounds1) || !task1.token.equals(mWinToken1)) &#123;</span><br><span class="line">        <span class="comment">//WindowContainerTransaction设置好对应的task的bound数据</span></span><br><span class="line">        wct.setBounds(task1.token, mBounds1);</span><br><span class="line">        wct.setSmallestScreenWidthDp(task1.token, getSmallestWidthDp(mBounds1));</span><br><span class="line">        mWinBounds1.set(mBounds1);</span><br><span class="line">        mWinToken1 = task1.token;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mBounds2.equals(mWinBounds2) || !task2.token.equals(mWinToken2)) &#123;</span><br><span class="line">        wct.setBounds(task2.token, mBounds2);</span><br><span class="line">        wct.setSmallestScreenWidthDp(task2.token, getSmallestWidthDp(mBounds2));</span><br><span class="line">        mWinBounds2.set(mBounds2);</span><br><span class="line">        mWinToken2 = task2.token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Resize a container.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowContainerTransaction <span class="title">setBounds</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull WindowContainerToken container,@NonNull Rect bounds)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Change的构造，bounds变化靠Change变量进行传递</span></span><br><span class="line">    Change chg = getOrCreateChange(container.asBinder());</span><br><span class="line">    chg.mConfiguration.windowConfiguration.setBounds(bounds);</span><br><span class="line">    chg.mConfigSetMask |= ActivityInfo.CONFIG_WINDOW_CONFIGURATION;</span><br><span class="line">    chg.mWindowSetMask |= WindowConfiguration.WINDOW_CONFIG_BOUNDS;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 对分屏的RootTask进行reorder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> WindowContainerTransaction <span class="title">reorder</span><span class="params">(@NonNull WindowContainerToken child, <span class="keyword">boolean</span> onTop)</span> </span>&#123;</span><br><span class="line">      mHierarchyOps.add(HierarchyOp.createForReorder(child.asBinder(), onTop));</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  	<span class="comment">//创建对应的HIERARCHY_OP_TYPE_REORDER的HierarchyOp进行传递</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HierarchyOp <span class="title">createForReorder</span><span class="params">(@NonNull IBinder container, <span class="keyword">boolean</span> toTop)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> HierarchyOp.Builder(HIERARCHY_OP_TYPE_REORDER)</span><br><span class="line">                  .setContainer(container)</span><br><span class="line">                  .setReparentContainer(container)</span><br><span class="line">                  .setToTop(toTop)</span><br><span class="line">                  .build();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>对分屏Task进行startTask</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowContainerTransaction <span class="title">startTask</span><span class="params">(<span class="keyword">int</span> taskId, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">        mHierarchyOps.add(HierarchyOp.createForTaskLaunch(taskId, options));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">/** Create a hierarchy op for launching a task. */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HierarchyOp <span class="title">createForTaskLaunch</span><span class="params">(<span class="keyword">int</span> taskId, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Bundle fullOptions = options == <span class="keyword">null</span> ? <span class="keyword">new</span> Bundle() : options;</span><br><span class="line">            fullOptions.putInt(LAUNCH_KEY_TASK_ID, taskId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> HierarchyOp.Builder(HIERARCHY_OP_TYPE_LAUNCH_TASK)</span><br><span class="line">                    .setToTop(<span class="keyword">true</span>)</span><br><span class="line">                    .setLaunchOptions(fullOptions)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="SystemServer部分"><a href="#SystemServer部分" class="headerlink" title="SystemServer部分"></a>SystemServer部分</h5><p>mTaskOrganizer.applyTransaction(wct);跨进程会调用到WindowOrganizerController的applyTransaction</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/services/core/java/com/android/server/wm/WindowOrganizerController.java</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyTransaction</span><span class="params">(@NonNull WindowContainerTransaction t, <span class="keyword">int</span> syncId,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Transition transition, @NonNull CallerInfo caller,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Transition finishTransition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//获取transition的change部分</span></span><br><span class="line">            Iterator&lt;Map.Entry&lt;IBinder, WindowContainerTransaction.Change&gt;&gt; entries =</span><br><span class="line">                    t.getChanges().entrySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (entries.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">final</span> Map.Entry&lt;IBinder, WindowContainerTransaction.Change&gt; entry = entries.next();</span><br><span class="line">                <span class="keyword">final</span> WindowContainer wc = WindowContainer.fromBinder(entry.getKey());</span><br><span class="line">				<span class="comment">//获取一个的change，change中包裹的具体WindowContainer，上屏和下屏的对应Task</span></span><br><span class="line">                <span class="keyword">int</span> containerEffect = applyWindowContainerChange(wc, entry.getValue(),</span><br><span class="line">                        t.getErrorCallbackToken());</span><br><span class="line">           </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Hierarchy changes</span></span><br><span class="line">            <span class="keyword">final</span> List&lt;WindowContainerTransaction.HierarchyOp&gt; hops = t.getHierarchyOps();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> hopSize = hops.size();</span><br><span class="line">            <span class="keyword">if</span> (hopSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isInLockTaskMode = mService.isInLockTaskMode();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hopSize; ++i) &#123;</span><br><span class="line">                <span class="comment">//对reorder和starTask的操作进行处理</span></span><br><span class="line">                    effects |= applyHierarchyOp(hops.get(i), effects, syncId, transition,</span><br><span class="line">                            isInLockTaskMode, caller, t.getErrorCallbackToken(),</span><br><span class="line">                            t.getTaskFragmentOrganizer(), finishTransition);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">           ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>总结一下systemserver端处理其实和systemui客户端一样的：<br>1、针对区域大小bounds的变化，对这个Change相关进行applyWindowContainerChange方法来进行处理<br>2、针对task相关的2类操作，reorder和startTask两类都是包装成了HierarchyOp，调用applyHierarchyOp方法来进行处理</p>
<p><strong>区域大小bounds变化applyWindowContainerChange</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">applyWindowContainerChange</span><span class="params">(WindowContainer wc,</span></span></span><br><span class="line"><span class="function"><span class="params">           WindowContainerTransaction.Change c, @Nullable IBinder errorCallbackToken)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> effects = applyChanges(wc, c, errorCallbackToken);</span><br><span class="line">       <span class="keyword">if</span> (wc <span class="keyword">instanceof</span> DisplayArea) &#123;</span><br><span class="line">           effects |= applyDisplayAreaChanges(wc.asDisplayArea(), c);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wc <span class="keyword">instanceof</span> Task) &#123;</span><br><span class="line">           effects |= applyTaskChanges(wc.asTask(), c);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> effects;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">applyChanges</span><span class="params">(WindowContainer&lt;?&gt; container,</span></span></span><br><span class="line"><span class="function"><span class="params">           WindowContainerTransaction.Change change, @Nullable IBinder errorCallbackToken)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//获取change的configration，bounds变化被包在了configration里面，再调用container的进行通知configration的变化</span></span><br><span class="line">               <span class="keyword">final</span> Configuration c =</span><br><span class="line">                       <span class="keyword">new</span> Configuration(container.getRequestedOverrideConfiguration());</span><br><span class="line">               c.setTo(change.getConfiguration(), configMask, windowMask);</span><br><span class="line">               <span class="comment">//把对应的bounds设置给了Task</span></span><br><span class="line">               container.onRequestedOverrideConfigurationChanged(c);         </span><br><span class="line">       <span class="keyword">return</span> effects;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>applyHierarchyOp</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">applyHierarchyOp</span><span class="params">(WindowContainerTransaction.HierarchyOp hop, <span class="keyword">int</span> effects,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> syncId, @Nullable Transition transition, <span class="keyword">boolean</span> isInLockTaskMode,</span></span></span><br><span class="line"><span class="function"><span class="params">           @NonNull CallerInfo caller, @Nullable IBinder errorCallbackToken,</span></span></span><br><span class="line"><span class="function"><span class="params">           @Nullable ITaskFragmentOrganizer organizer, @Nullable Transition finishTransition)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> type = hop.getType();</span><br><span class="line">         <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">				 <span class="keyword">case</span> HIERARCHY_OP_TYPE_LAUNCH_TASK: &#123;</span><br><span class="line">           </span><br><span class="line">           <span class="comment">//这个launchOpts就是systemui传递的mainOptions和sideOptions，launchOpts里面的关键数据KEY_LAUNCH_ROOT_TASK_TOKEN，即stage.mRootTaskInfo.token</span></span><br><span class="line">               <span class="keyword">final</span> Bundle launchOpts = hop.getLaunchOptions();</span><br><span class="line">               <span class="comment">//注意这里是获取具体要启动app的taskId，不是上下分屏的id</span></span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> taskId = launchOpts.getInt(</span><br><span class="line">                       WindowContainerTransaction.HierarchyOp.LAUNCH_KEY_TASK_ID);</span><br><span class="line">               <span class="comment">//转化成SafeActivityOptions类型</span></span><br><span class="line">               <span class="keyword">final</span> SafeActivityOptions safeOptions =</span><br><span class="line">                       SafeActivityOptions.fromBundle(launchOpts, caller.mPid, caller.mUid)                 </span><br><span class="line">               <span class="comment">//这里有个线程切换操作，而且还会等执行完成        </span></span><br><span class="line">               waitAsyncStart(() -&gt; mService.mTaskSupervisor.startActivityFromRecents(</span><br><span class="line">                       caller.mPid, caller.mUid, taskId, safeOptions));</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startActivityFromRecents</span><span class="params">(<span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> taskId,</span></span></span><br><span class="line"><span class="function"><span class="params">            SafeActivityOptions options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Task task;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> taskCallingUid;</span><br><span class="line">        <span class="keyword">final</span> String callingPackage;</span><br><span class="line">        <span class="keyword">final</span> String callingFeatureId;</span><br><span class="line">        <span class="keyword">final</span> Intent intent;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId;</span><br><span class="line">        <span class="comment">//获取传递进来的options，获取上下分屏的容器task</span></span><br><span class="line">        <span class="keyword">final</span> ActivityOptions activityOptions = options != <span class="keyword">null</span></span><br><span class="line">                ? options.getOptions(<span class="keyword">this</span>)</span><br><span class="line">                : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> moveHomeTaskForward = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mService.mGlobalLock) &#123;</span><br><span class="line">            <span class="keyword">int</span> activityType = ACTIVITY_TYPE_UNDEFINED;</span><br><span class="line">            <span class="keyword">if</span> (activityOptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">                activityType = activityOptions.getLaunchActivityType();</span><br><span class="line">              ... </span><br><span class="line">           <span class="comment">//通过taskId来获取一个Task，把taskId对应的Task进行reparent到新上下分屏的容器Task，实现层级结构树上面的挂载完成，剩下就是一系列操作来保证Activiyt生命周期正常         </span></span><br><span class="line">                task = mRootWindowContainer.anyTaskForId(taskId,</span><br><span class="line">                        MATCH_ATTACHED_TASK_OR_RECENT_TASKS_AND_RESTORE, activityOptions, ON_TOP);</span><br><span class="line">              <span class="comment">//获取了task之后进行相关的Activity操作</span></span><br><span class="line">                <span class="keyword">if</span> (!mService.mAmInternal.shouldConfirmCredentials(task.mUserId)</span><br><span class="line">                        &amp;&amp; task.getRootActivity() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//获取task的Activity</span></span><br><span class="line">                    <span class="keyword">final</span> ActivityRecord targetActivity = task.getTopNonFinishingActivity();             </span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//这里非常关键的把task移动到前台，在里面会对focus和resume进行设置</span></span><br><span class="line">                        mService.moveTaskToFrontLocked(<span class="keyword">null</span> <span class="comment">/* appThread */</span>,</span><br><span class="line">                                <span class="keyword">null</span> <span class="comment">/* callingPackage */</span>, task.mTaskId, <span class="number">0</span>, options);</span><br><span class="line">                      ...</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    </span><br><span class="line"> <span class="function">Task <span class="title">anyTaskForId</span><span class="params">(<span class="keyword">int</span> id, @RootWindowContainer.AnyTaskForIdMatchTaskMode <span class="keyword">int</span> matchMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable ActivityOptions aOptions, <span class="keyword">boolean</span> onTop)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">final</span> PooledPredicate p = PooledLambda.obtainPredicate(</span><br><span class="line">                Task::isTaskId, PooledLambda.__(Task<span class="class">.<span class="keyword">class</span>), <span class="title">id</span>)</span>;</span><br><span class="line">        Task task = getTask(p);<span class="comment">//遍历获取Task</span></span><br><span class="line">        p.recycle();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (aOptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">             	<span class="comment">//这里有调用了getOrCreateRootTask来获取targetRootTask</span></span><br><span class="line">                <span class="keyword">final</span> Task targetRootTask =</span><br><span class="line">                        getOrCreateRootTask(<span class="keyword">null</span>, aOptions, task, onTop);</span><br><span class="line">                <span class="keyword">if</span> (targetRootTask != <span class="keyword">null</span> &amp;&amp; task.getRootTask() != targetRootTask) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> reparentMode = onTop</span><br><span class="line">                            ? REPARENT_MOVE_ROOT_TASK_TO_FRONT : REPARENT_LEAVE_ROOT_TASK_IN_PLACE;</span><br><span class="line">                    task.reparent(targetRootTask, onTop, reparentMode, ANIMATE, DEFER_RESUME,</span><br><span class="line">                            <span class="string">"anyTaskForId"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> task;</span><br><span class="line">        &#125;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">Task <span class="title">getOrCreateRootTask</span><span class="params">(@Nullable ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable ActivityOptions options, @Nullable Task candidateTask,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Task sourceTask, <span class="keyword">boolean</span> onTop,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable LaunchParamsController.LaunchParams launchParams, <span class="keyword">int</span> launchFlags)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// First preference goes to the launch root task set in the activity options.</span></span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//systemui传递的mainoptions</span></span><br><span class="line">            <span class="keyword">final</span> Task candidateRoot = Task.fromWindowContainerToken(options.getLaunchRootTask());</span><br><span class="line">            <span class="keyword">if</span> (candidateRoot != <span class="keyword">null</span> &amp;&amp; canLaunchOnDisplay(r, candidateRoot)) &#123;</span><br><span class="line">                <span class="keyword">return</span> candidateRoot;<span class="comment">//直接返回了options带的task</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>再看下最重要的moveTaskToFrontLocked方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">moveTaskToFrontLocked</span><span class="params">(@Nullable IApplicationThread appThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable String callingPackage, <span class="keyword">int</span> taskId, <span class="keyword">int</span> flags, SafeActivityOptions options)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Task task = mRootWindowContainer.anyTaskForId(taskId);</span><br><span class="line">            ...</span><br><span class="line">            ActivityOptions realOptions = options != <span class="keyword">null</span></span><br><span class="line">                    ? options.getOptions(mTaskSupervisor)</span><br><span class="line">                    : <span class="keyword">null</span>;</span><br><span class="line">             <span class="comment">//寻找到task而且移到最前端</span></span><br><span class="line">            mTaskSupervisor.findTaskToMoveToFront(task, flags, realOptions, <span class="string">"moveTaskToFront"</span>,</span><br><span class="line">                    <span class="keyword">false</span> <span class="comment">/* forceNonResizable */</span>);</span><br><span class="line">				</span><br><span class="line">			<span class="comment">//开始启动StartingWindow</span></span><br><span class="line">            <span class="keyword">final</span> ActivityRecord topActivity = task.getTopNonFinishingActivity();</span><br><span class="line">            <span class="keyword">if</span> (topActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// We are reshowing a task, use a starting window to hide the initial draw delay</span></span><br><span class="line">                <span class="comment">// so the transition can start earlier.</span></span><br><span class="line">                topActivity.showStartingWindow(<span class="keyword">true</span> <span class="comment">/* taskSwitch */</span>);</span><br><span class="line">            &#125;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line"><span class="comment">/** This doesn't just find a task, it also moves the task to front. */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">findTaskToMoveToFront</span><span class="params">(Task task, <span class="keyword">int</span> flags, ActivityOptions options, String reason,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> forceNonResizeable)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//这里currentRootTask是根task</span></span><br><span class="line">        Task currentRootTask = task.getRootTask();</span><br><span class="line">        ...</span><br><span class="line">            <span class="keyword">final</span> ActivityRecord r = task.getTopNonFinishingActivity();</span><br><span class="line">            <span class="comment">//这里又调用到了关键moveTaskToFront方法</span></span><br><span class="line">            currentRootTask.moveTaskToFront(task, <span class="keyword">false</span> <span class="comment">/* noAnimation */</span>, options,</span><br><span class="line">                    r == <span class="keyword">null</span> ? <span class="keyword">null</span> : r.appTimeTracker, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">moveTaskToFront</span><span class="params">(Task tr, <span class="keyword">boolean</span> noAnimation, ActivityOptions options,</span></span></span><br><span class="line"><span class="function"><span class="params">            AppTimeTracker timeTracker, <span class="keyword">boolean</span> deferResume, String reason)</span> </span>&#123;</span><br><span class="line">      		...</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set focus to the top running activity of this task and move all its parents to top.</span></span><br><span class="line">            <span class="comment">//调用到了顶部ActivityRecord的moveFocusableActivityToTop方法</span></span><br><span class="line">            top.moveFocusableActivityToTop(reason);</span><br><span class="line">			...</span><br><span class="line">            <span class="keyword">if</span> (!deferResume) &#123;<span class="comment">//进行对应resume操作</span></span><br><span class="line">                mRootWindowContainer.resumeFocusedTasksTopActivities();</span><br><span class="line">            &#125;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">moveFocusableActivityToTop</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Task rootTask = getRootTask();</span><br><span class="line">   		<span class="comment">//rootTask把当前app的task移到最前</span></span><br><span class="line">        rootTask.moveToFront(reason, task);</span><br><span class="line">        <span class="comment">// Report top activity change to tracking services and WM</span></span><br><span class="line">        <span class="keyword">if</span> (mRootWindowContainer.getTopResumedActivity() == <span class="keyword">this</span>) &#123; </span><br><span class="line">          <span class="comment">//下面还需要设置，是因为getTopResumedActivity可能为null，还会通过getFocusedActivity作为ResumedActivity</span></span><br><span class="line">          <span class="comment">//把ActivityRecord变成Resumed状态</span></span><br><span class="line">            mAtmService.setResumedActivityUncheckLocked(<span class="keyword">this</span>, reason);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">ActivityRecord <span class="title">getTopResumedActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Task focusedRootTask = getTopDisplayFocusedRootTask();</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord resumedActivity = focusedRootTask.getTopResumedActivity();</span><br><span class="line">        <span class="keyword">if</span> (resumedActivity != <span class="keyword">null</span> &amp;&amp; resumedActivity.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> resumedActivity;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// The top focused root task might not have a resumed activity yet - look on all displays in</span></span><br><span class="line">        <span class="comment">// focus order.</span></span><br><span class="line">        <span class="comment">//resumedActivity为null后获取getFocusedActivity</span></span><br><span class="line">        <span class="keyword">return</span> getItemFromTaskDisplayAreas(TaskDisplayArea::getFocusedActivity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h4><h5 id="分割线创建"><a href="#分割线创建" class="headerlink" title="分割线创建"></a>分割线创建</h5><p>DividerSnapAlgorithm是专门管理分割线位置相关的算法类</p>
<p>frameworks/base/core/java/com/android/internal/policy/DividerSnapAlgorithm.java</p>
<p>分割线的代表类SnapTarget</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DividerSnapAlgorithm内部类</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Represents a snap target for the divider.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SnapTarget</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_NONE = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** If the divider reaches this value, the left/top task should be dismissed. */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_DISMISS_START = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** If the divider reaches this value, the right/bottom task should be dismissed */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_DISMISS_END = <span class="number">2</span>;</span><br><span class="line">		<span class="comment">//表分割线位置</span></span><br><span class="line">        <span class="comment">/** Position of this snap target. The right/bottom edge of the top/left task snaps here. */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> position;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Like &#123;<span class="doctag">@link</span> #position&#125;, but used to calculate the task bounds which might be different</span></span><br><span class="line"><span class="comment">         * from the stack bounds.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> taskPosition;</span><br><span class="line">		<span class="comment">//区分边际分割线，主要有FLAG_DISMISS_START（上）和FLAG_DISMISS_END（下），其他都是FLAG_NONE</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> flag;</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">boolean</span> isMiddleTarget;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Multiplier used to calculate distance to snap position. The lower this value, the harder</span></span><br><span class="line"><span class="comment">         * it's to snap on this target</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//这个属于一个放大因子，针对首尾分割线距离的放大，让首尾分割线不会因为误触进入</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span> distanceMultiplier;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>计算分割线方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">calculateTargets</span><span class="params">(<span class="keyword">boolean</span> isHorizontalDivision, <span class="keyword">int</span> dockedSide)</span> </span>&#123;</span><br><span class="line">        mTargets.clear();</span><br><span class="line">        <span class="keyword">int</span> dividerMax = isHorizontalDivision</span><br><span class="line">                ? mDisplayHeight</span><br><span class="line">                : mDisplayWidth;</span><br><span class="line">        <span class="keyword">int</span> startPos = -mDividerSize;</span><br><span class="line">        <span class="keyword">if</span> (dockedSide == DOCKED_RIGHT) &#123;</span><br><span class="line">            startPos += mInsets.left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//首先添加SnapTarget.FLAG_DISMISS_START的SnapTarget</span></span><br><span class="line">        mTargets.add(<span class="keyword">new</span> SnapTarget(startPos, startPos, SnapTarget.FLAG_DISMISS_START,</span><br><span class="line">                <span class="number">0.35f</span>));</span><br><span class="line">        <span class="keyword">switch</span> (mSnapMode) &#123;<span class="comment">//这里需要根据mSnapMode来分别创建分割情况</span></span><br><span class="line">            <span class="keyword">case</span> SNAP_MODE_16_9:<span class="comment">//正常竖屏就是SNAP_MODE_16_9，一般会创建3个分割线</span></span><br><span class="line">                addRatio16_9Targets(isHorizontalDivision, dividerMax);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SNAP_FIXED_RATIO:</span><br><span class="line">                addFixedDivisionTargets(isHorizontalDivision, dividerMax);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SNAP_ONLY_1_1:<span class="comment">//正常横屏就是SNAP_ONLY_1_1，所以只有中间一个分割线</span></span><br><span class="line">                addMiddleTarget(isHorizontalDivision);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SNAP_MODE_MINIMIZED:</span><br><span class="line">                addMinimizedTarget(isHorizontalDivision, dockedSide);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//最后添加SnapTarget.FLAG_DISMISS_END的SnapTarget</span></span><br><span class="line">        mTargets.add(<span class="keyword">new</span> SnapTarget(dividerMax, dividerMax, SnapTarget.FLAG_DISMISS_END, <span class="number">0.35f</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>参数isHorizontalDivision，代表是当前分割线是横着显示还是竖着显示，竖屏分割线是横着显示isHorizontalDivision =true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DividerSnapAlgorithm</span><span class="params">(Resources res, <span class="keyword">int</span> displayWidth, <span class="keyword">int</span> displayHeight, <span class="keyword">int</span> dividerSize,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> isHorizontalDivision, Rect insets, <span class="keyword">int</span> dockSide, <span class="keyword">boolean</span> isMinimizedMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> isHomeResizable)</span> </span>&#123;</span><br><span class="line">            mSnapMode = isMinimizedMode ? SNAP_MODE_MINIMIZED :</span><br><span class="line">                res.getInteger(com.android.internal.R.integer.config_dockedStackDividerSnapMode);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//res/config.xml</span></span><br><span class="line">&lt;integer name="config_dockedStackDividerSnapMode"&gt;0&lt;/integer&gt;</span><br><span class="line"><span class="comment">//res-land/config.xml</span></span><br><span class="line">&lt;integer name="config_dockedStackDividerSnapMode"&gt;2&lt;/integer&gt;  </span><br><span class="line">    </span><br><span class="line"> 	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3 snap targets: left/top has 16:9 ratio (for videos), 1:1, and right/bottom has 16:9 ratio</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SNAP_MODE_16_9 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3 snap targets: fixed ratio, 1:1, (1 - fixed ratio)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SNAP_FIXED_RATIO = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1 snap target: 1:1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SNAP_ONLY_1_1 = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>竖屏值一般是SNAP_MODE_16_9=0，横屏值一般是SNAP_ONLY_1_1=2</p>
<p>竖屏的3个snap的计算方法addRatio16_9Targets</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addRatio16_9Targets</span><span class="params">(<span class="keyword">boolean</span> isHorizontalDivision, <span class="keyword">int</span> dividerMax)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = isHorizontalDivision ? mInsets.top : mInsets.left;</span><br><span class="line">    <span class="keyword">int</span> end = isHorizontalDivision</span><br><span class="line">            ? mDisplayHeight - mInsets.bottom</span><br><span class="line">            : mDisplayWidth - mInsets.right;</span><br><span class="line">    <span class="keyword">int</span> startOther = isHorizontalDivision ? mInsets.left : mInsets.top;</span><br><span class="line">    <span class="keyword">int</span> endOther = isHorizontalDivision</span><br><span class="line">            ? mDisplayWidth - mInsets.right</span><br><span class="line">            : mDisplayHeight - mInsets.bottom;</span><br><span class="line">    <span class="keyword">float</span> size = <span class="number">9.0f</span> / <span class="number">16.0f</span> * (endOther - startOther);</span><br><span class="line">    <span class="keyword">int</span> sizeInt = (<span class="keyword">int</span>) Math.floor(size);</span><br><span class="line">    <span class="keyword">int</span> topPosition = start + sizeInt;</span><br><span class="line">    <span class="keyword">int</span> bottomPosition = end - sizeInt - mDividerSize;</span><br><span class="line">    <span class="comment">//计算了topPosition，bottomPosition两个位置，就是3分割线的上下分割线位置</span></span><br><span class="line">    addNonDismissingTargets(isHorizontalDivision, topPosition, bottomPosition, dividerMax);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addNonDismissingTargets</span><span class="params">(<span class="keyword">boolean</span> isHorizontalDivision, <span class="keyword">int</span> topPosition,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> bottomPosition, <span class="keyword">int</span> dividerMax)</span> </span>&#123;</span><br><span class="line">        maybeAddTarget(topPosition, topPosition - getStartInset());</span><br><span class="line">        addMiddleTarget(isHorizontalDivision);</span><br><span class="line">        maybeAddTarget(bottomPosition,</span><br><span class="line">                dividerMax - getEndInset() - (bottomPosition + mDividerSize));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addMiddleTarget</span><span class="params">(<span class="keyword">boolean</span> isHorizontalDivision)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> position = DockedDividerUtils.calculateMiddlePosition(isHorizontalDivision,</span><br><span class="line">                mInsets, mDisplayWidth, mDisplayHeight, mDividerSize);</span><br><span class="line">        mTargets.add(<span class="keyword">new</span> SnapTarget(position, position, SnapTarget.FLAG_NONE));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>addNonDismissingTargets方法主要就是有了topPosition，bottomPosition，在额外加上个middle，这样整体3个SnapTarget就构造成功。创建后的分割线SnapTarget都会被放入到mTargets这个集合中去</p>
<p>SnapTarget对应中间位置的堆栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">at com.android.internal.policy.DividerSnapAlgorithm$SnapTarget.&lt;init&gt;(DividerSnapAlgorithm.java:472)</span><br><span class="line">at com.android.internal.policy.DividerSnapAlgorithm$SnapTarget.&lt;init&gt;(DividerSnapAlgorithm.java:468)</span><br><span class="line">at com.android.internal.policy.DividerSnapAlgorithm.maybeAddTarget(DividerSnapAlgorithm.java:356)</span><br><span class="line">at com.android.internal.policy.DividerSnapAlgorithm.addNonDismissingTargets(DividerSnapAlgorithm.java:317)</span><br><span class="line">at com.android.internal.policy.DividerSnapAlgorithm.addRatio16_9Targets(DividerSnapAlgorithm.java:347)</span><br><span class="line">at com.android.internal.policy.DividerSnapAlgorithm.calculateTargets(DividerSnapAlgorithm.java:299)</span><br><span class="line">at com.android.internal.policy.DividerSnapAlgorithm.&lt;init&gt;(DividerSnapAlgorithm.java:138)</span><br><span class="line">at com.android.internal.policy.DividerSnapAlgorithm.&lt;init&gt;(DividerSnapAlgorithm.java:112)</span><br><span class="line">at com.android.wm.shell.common.split.SplitLayout.getSnapAlgorithm(SplitLayout.java:433)</span><br><span class="line">at com.android.wm.shell.common.split.SplitLayout.&lt;init&gt;(SplitLayout.java:134)</span><br><span class="line">at com.android.wm.shell.splitscreen.StageCoordinator.onTaskAppeared(StageCoordinator.java:958)</span><br><span class="line">at com.android.wm.shell.ShellTaskOrganizer.onTaskAppeared(ShellTaskOrganizer.java:438)</span><br><span class="line">at com.android.wm.shell.ShellTaskOrganizer.onTaskAppeared(ShellTaskOrganizer.java:427)</span><br><span class="line">at android.window.TaskOrganizer$1.lambda$onTaskAppeared$4$android-window-TaskOrganizer$1(TaskOrganizer.java:306)</span><br></pre></td></tr></table></figure>

<h5 id="寻找合适分割线"><a href="#寻找合适分割线" class="headerlink" title="寻找合适分割线"></a>寻找合适分割线</h5><p><strong>外部传递一个比例值情况</strong><br>一般这种情况是在启动分屏时候，需要设置好一个上下分屏比例ratio,主要通过如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Updates divide position and split bounds base on the ratio within root bounds. */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDivideRatio</span><span class="params">(<span class="keyword">float</span> ratio)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> position = isLandscape()</span><br><span class="line">            ? mRootBounds.left + (<span class="keyword">int</span>) (mRootBounds.width() * ratio)</span><br><span class="line">            : mRootBounds.top + (<span class="keyword">int</span>) (mRootBounds.height() * ratio);</span><br><span class="line">    <span class="keyword">final</span> DividerSnapAlgorithm.SnapTarget snapTarget =</span><br><span class="line">            mDividerSnapAlgorithm.calculateNonDismissingSnapTarget(position);</span><br><span class="line">    setDividePosition(snapTarget.position, <span class="keyword">false</span> <span class="comment">/* applyLayoutChange */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> SnapTarget <span class="title">calculateNonDismissingSnapTarget</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        SnapTarget target = snap(position, <span class="keyword">false</span> <span class="comment">/* hardDismiss */</span>);<span class="comment">//主要调用snap</span></span><br><span class="line">        <span class="keyword">if</span> (target == mDismissStartTarget) &#123;</span><br><span class="line">            <span class="keyword">return</span> mFirstSplitTarget;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (target == mDismissEndTarget) &#123;</span><br><span class="line">            <span class="keyword">return</span> mLastSplitTarget;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> target;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SnapTarget <span class="title">snap</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span> hardDismiss)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldApplyFreeSnapMode(position)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SnapTarget(position, position, SnapTarget.FLAG_NONE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> minIndex = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">float</span> minDistance = Float.MAX_VALUE;</span><br><span class="line">        <span class="keyword">int</span> size = mTargets.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            SnapTarget target = mTargets.get(i);</span><br><span class="line">            <span class="keyword">float</span> distance = Math.abs(position - target.position);</span><br><span class="line">            <span class="keyword">if</span> (hardDismiss) &#123;</span><br><span class="line">                distance /= target.distanceMultiplier;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (distance &lt; minDistance) &#123;<span class="comment">//这里会计算传递进来position和SnapTarget.position的距离</span></span><br><span class="line">                minIndex = i;</span><br><span class="line">                minDistance = distance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mTargets.get(minIndex);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>snap方法根据传递进来的position，与mTargets集合的所有position进行比较距离，离谁最近就选谁。</p>
<h5 id="分割线拖动"><a href="#分割线拖动" class="headerlink" title="分割线拖动"></a>分割线拖动</h5><p>在DividerView的onTouch方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mSplitLayout == <span class="keyword">null</span> || !mInteractive) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mDoubleTapDetector.onTouchEvent(event)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Convert to use screen-based coordinates to prevent lost track of motion events while</span></span><br><span class="line">    <span class="comment">// moving divider bar and calculating dragging velocity.</span></span><br><span class="line">    event.setLocation(event.getRawX(), event.getRawY());</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = event.getAction() &amp; MotionEvent.ACTION_MASK;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isLandscape = isLandscape();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> touchPos = (<span class="keyword">int</span>) (isLandscape ? event.getX() : event.getY());</span><br><span class="line">    <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            mVelocityTracker = VelocityTracker.obtain();</span><br><span class="line">            mVelocityTracker.addMovement(event);</span><br><span class="line">            setTouching();</span><br><span class="line">            mStartPos = touchPos;</span><br><span class="line">            mMoving = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">            mVelocityTracker.addMovement(event);</span><br><span class="line">            <span class="keyword">if</span> (!mMoving &amp;&amp; Math.abs(touchPos - mStartPos) &gt; mTouchSlop) &#123;</span><br><span class="line">                mStartPos = touchPos;</span><br><span class="line">                mMoving = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mMoving) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> position = mSplitLayout.getDividePosition() + touchPos - mStartPos;</span><br><span class="line">                mSplitLayout.updateDivideBounds(position);<span class="comment">//最重要的拖动方法</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">            releaseTouching();</span><br><span class="line">            <span class="keyword">if</span> (!mMoving) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            mVelocityTracker.addMovement(event);</span><br><span class="line">            mVelocityTracker.computeCurrentVelocity(<span class="number">1000</span> <span class="comment">/* units */</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> velocity = isLandscape</span><br><span class="line">                    ? mVelocityTracker.getXVelocity()</span><br><span class="line">                    : mVelocityTracker.getYVelocity();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> position = mSplitLayout.getDividePosition() + touchPos - mStartPos;</span><br><span class="line">            <span class="keyword">final</span> DividerSnapAlgorithm.SnapTarget snapTarget =</span><br><span class="line">                    mSplitLayout.findSnapTarget(position, velocity, <span class="keyword">false</span> <span class="comment">/* hardDismiss */</span>);</span><br><span class="line">            mSplitLayout.snapToTarget(position, snapTarget);<span class="comment">//松手后要进行动画，DividerView自动到某个区域</span></span><br><span class="line">            mMoving = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点看下mSplitLayout.updateDivideBounds(position)方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Updates bounds with the passing position. Usually used to update recording bounds while</span></span><br><span class="line"><span class="comment">  * performing animation or dragging divider bar to resize the splits.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">updateDivideBounds</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">     updateBounds(position);<span class="comment">//更新一下bound区域</span></span><br><span class="line">     mSplitLayoutHandler.onLayoutSizeChanging(<span class="keyword">this</span>);</span><br><span class="line">     <span class="comment">//会调用对应的onLayoutSizeChanging方法来负责通知size变化了</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutSizeChanging</span><span class="params">(SplitLayout layout)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">final</span> SurfaceControl.Transaction t = mTransactionPool.acquire();</span><br><span class="line">     t.setFrameTimelineVsync(Choreographer.getInstance().getVsyncId());</span><br><span class="line">     setResizingSplits(<span class="keyword">true</span> <span class="comment">/* resizing */</span>);</span><br><span class="line">     <span class="comment">//会把对应的DividerView进行坐标更新，实现跟手</span></span><br><span class="line">     updateSurfaceBounds(layout, t, <span class="keyword">true</span> <span class="comment">/* applyResizingOffset */</span>);</span><br><span class="line">     <span class="comment">//主区域有size变化，如果bounds变大则显示icon+背景，否则显示原来内容，并控制内容的区域跟随divideriew位置</span></span><br><span class="line">     mMainStage.onResizing(getMainStageBounds(), t);</span><br><span class="line">     <span class="comment">//次区域有size变化，如果bounds变大则显示icon+背景，否则显示原来内容，并控制内容的区域跟随divideriew位置</span></span><br><span class="line">     mSideStage.onResizing(getSideStageBounds(), t);</span><br><span class="line">     t.apply();</span><br><span class="line">     mTransactionPool.release(t);</span><br><span class="line"> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateSurfaceBounds</span><span class="params">(@Nullable SplitLayout layout, @NonNull SurfaceControl.Transaction t,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">boolean</span> applyResizingOffset)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">final</span> StageTaskListener topLeftStage =</span><br><span class="line">             mSideStagePosition == SPLIT_POSITION_TOP_OR_LEFT ? mSideStage : mMainStage;</span><br><span class="line">     <span class="keyword">final</span> StageTaskListener bottomRightStage =</span><br><span class="line">             mSideStagePosition == SPLIT_POSITION_TOP_OR_LEFT ? mMainStage : mSideStage;</span><br><span class="line">      <span class="comment">//这里关键调用了applySurfaceChanges</span></span><br><span class="line">     (layout != <span class="keyword">null</span> ? layout : mSplitLayout).applySurfaceChanges(t, topLeftStage.mRootLeash,</span><br><span class="line">             bottomRightStage.mRootLeash, topLeftStage.mDimLayer, bottomRightStage.mDimLayer,</span><br><span class="line">             applyResizingOffset);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>applySurfaceChanges方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applySurfaceChanges</span><span class="params">(SurfaceControl.Transaction t, SurfaceControl leash1,</span></span></span><br><span class="line"><span class="function"><span class="params">            SurfaceControl leash2, SurfaceControl dimLayer1, SurfaceControl dimLayer2,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> applyResizingOffset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SurfaceControl dividerLeash = getDividerLeash();</span><br><span class="line">        <span class="keyword">if</span> (dividerLeash != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTempRect.set(getRefDividerBounds());</span><br><span class="line">            t.setPosition(dividerLeash, mTempRect.left, mTempRect.top);</span><br><span class="line">            <span class="comment">//这里是设置DeviderView进行位置设置</span></span><br><span class="line">            <span class="comment">// Resets layer of divider bar to make sure it is always on top.</span></span><br><span class="line">            t.setLayer(dividerLeash, Integer.MAX_VALUE);</span><br><span class="line">        &#125;</span><br><span class="line">        mTempRect.set(getRefBounds1());</span><br><span class="line">    	<span class="comment">//设置上下分屏的位置和裁减</span></span><br><span class="line">        t.setPosition(leash1, mTempRect.left, mTempRect.top)</span><br><span class="line">                .setWindowCrop(leash1, mTempRect.width(), mTempRect.height());</span><br><span class="line">        mTempRect.set(getRefBounds2());</span><br><span class="line">        t.setPosition(leash2, mTempRect.left, mTempRect.top)</span><br><span class="line">                .setWindowCrop(leash2, mTempRect.width(), mTempRect.height());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mImePositionProcessor.adjustSurfaceLayoutForIme(</span><br><span class="line">                t, dividerLeash, leash1, leash2, dimLayer1, dimLayer2)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//进行对应的特效显示，拉到底部或顶部进行灰度提示</span></span><br><span class="line">        mSurfaceEffectPolicy.adjustDimSurface(t, dimLayer1, dimLayer2);</span><br><span class="line">        <span class="keyword">if</span> (applyResizingOffset) &#123;</span><br><span class="line">            mSurfaceEffectPolicy.adjustRootSurface(t, leash1, leash2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>mMainStage.onResizing方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** Showing resizing hint. */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResizing</span><span class="params">(ActivityManager.RunningTaskInfo resizingTask, Rect newBounds,</span></span></span><br><span class="line"><span class="function"><span class="params">           SurfaceControl.Transaction t)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//这里本质就是判断是否该区域有变大，如果有变大则变成ICON+背景，另一个屏则保持原样，因为show是为false</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> show =</span><br><span class="line">               newBounds.width() &gt; mBounds.width() || newBounds.height() &gt; mBounds.height();</span><br><span class="line">		...</span><br><span class="line">       t.setPosition(mIconLeash,</span><br><span class="line">               newBounds.width() / <span class="number">2</span> - mIconSize / <span class="number">2</span>,</span><br><span class="line">               newBounds.height() / <span class="number">2</span> - mIconSize / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (animate) &#123;<span class="comment">//启动相关显示的动画</span></span><br><span class="line">           startFadeAnimation(show, <span class="keyword">false</span> <span class="comment">/* isResized */</span>);</span><br><span class="line">           mShown = show;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>松手后mSplitLayout.snapToTarget(position, snapTarget)执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Sets new divide position and updates bounds correspondingly. Notifies listener if the new</span></span><br><span class="line"><span class="comment">   * target indicates dismissing split.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">snapToTarget</span><span class="params">(<span class="keyword">int</span> currentPosition, DividerSnapAlgorithm.SnapTarget snapTarget)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (snapTarget.flag) &#123;</span><br><span class="line">          <span class="comment">//DividerView上滑到顶部，导致上分屏退出</span></span><br><span class="line">          <span class="keyword">case</span> FLAG_DISMISS_START:</span><br><span class="line">              flingDividePosition(currentPosition, snapTarget.position,</span><br><span class="line">                      () -&gt; mSplitLayoutHandler.onSnappedToDismiss(<span class="keyword">false</span> <span class="comment">/* bottomOrRight */</span>));</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> FLAG_DISMISS_END:</span><br><span class="line">              flingDividePosition(currentPosition, snapTarget.position,</span><br><span class="line">                      () -&gt; mSplitLayoutHandler.onSnappedToDismiss(<span class="keyword">true</span> <span class="comment">/* bottomOrRight */</span>));</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">              flingDividePosition(currentPosition, snapTarget.position,</span><br><span class="line">                      () -&gt; setDividePosition(snapTarget.position, <span class="keyword">true</span> <span class="comment">/* applyLayoutChange */</span>));</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">flingDividePosition</span><span class="params">(<span class="keyword">int</span> from, <span class="keyword">int</span> to, @Nullable Runnable flingFinishedCallback)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (from == to) &#123;</span><br><span class="line">          <span class="comment">// No animation run, still callback to stop resizing.</span></span><br><span class="line">          mSplitLayoutHandler.onLayoutSizeChanged(<span class="keyword">this</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      InteractionJankMonitorUtils.beginTracing(InteractionJankMonitor.CUJ_SPLIT_SCREEN_RESIZE,</span><br><span class="line">              mSplitWindowManager.getDividerView(), <span class="string">"Divider fling"</span>);</span><br><span class="line">      ValueAnimator animator = ValueAnimator</span><br><span class="line">              .ofInt(from, to)</span><br><span class="line">              .setDuration(<span class="number">250</span>);<span class="comment">//开始设置动画，一个from一个to作为开始和截至地方</span></span><br><span class="line">      animator.setInterpolator(Interpolators.FAST_OUT_SLOW_IN);</span><br><span class="line">      animator.addUpdateListener(</span><br><span class="line">              animation -&gt; updateDivideBounds((<span class="keyword">int</span>) animation.getAnimatedValue()));</span><br><span class="line">      animator.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">          	<span class="comment">//动画结束以后的最重要的操作，需要真正的windowcontainer的bounds进行操作了</span></span><br><span class="line">              <span class="keyword">if</span> (flingFinishedCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  flingFinishedCallback.run();<span class="comment">//执行传递进来的那个runable</span></span><br><span class="line">              &#125;</span><br><span class="line">              InteractionJankMonitorUtils.endTracing(</span><br><span class="line">                      InteractionJankMonitor.CUJ_SPLIT_SCREEN_RESIZE);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">              setDividePosition(to, <span class="keyword">true</span> <span class="comment">/* applyLayoutChange */</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      animator.start();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="分屏退出"><a href="#分屏退出" class="headerlink" title="分屏退出"></a>分屏退出</h4><h5 id="SystemUI端的调用"><a href="#SystemUI端的调用" class="headerlink" title="SystemUI端的调用"></a>SystemUI端的调用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/libs/WindowManager/Shell/src/com/android/wm/shell/splitscreen/StageCoordinator.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyExitSplitScreen</span><span class="params">(@Nullable StageTaskListener childrenToTop,</span></span></span><br><span class="line"><span class="function"><span class="params">            WindowContainerTransaction wct, @ExitReason <span class="keyword">int</span> exitReason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> fromEnteringPip = exitReason == EXIT_REASON_CHILD_TASK_ENTER_PIP;</span><br><span class="line">     	<span class="comment">//移除对应的sidestate下面task节点,其实本质就是把子节点进行对应的reparent到新的父亲</span></span><br><span class="line">        mSideStage.removeAllTasks(wct, !fromEnteringPip &amp;&amp; mSideStage == childrenToTop);</span><br><span class="line">     	<span class="comment">//和上面的removeAllTask类似，都是对task进行reparent操作，不能再继续挂载在分屏的节点了</span></span><br><span class="line">        mMainStage.deactivate(wct, !fromEnteringPip &amp;&amp; mMainStage == childrenToTop);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//对分屏的总节点进行对应的reorder，放到后面了</span></span><br><span class="line">        wct.reorder(mRootTaskInfo.token, <span class="keyword">false</span> <span class="comment">/* onTop */</span>);</span><br><span class="line">        mTaskOrganizer.applyTransaction(wct);</span><br><span class="line">        mSyncQueue.runInSync(t -&gt; &#123;</span><br><span class="line">            setResizingSplits(<span class="keyword">false</span> <span class="comment">/* resizing */</span>);</span><br><span class="line">            t.setWindowCrop(mMainStage.mRootLeash, <span class="keyword">null</span>)</span><br><span class="line">                    .setWindowCrop(mSideStage.mRootLeash, <span class="keyword">null</span>);</span><br><span class="line">            setDividerVisibility(<span class="keyword">false</span>, t);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>mSideStage.removeAllTasks方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">removeAllTasks</span><span class="params">(WindowContainerTransaction wct, <span class="keyword">boolean</span> toTop)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (mChildrenTaskInfo.size() == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">     wct.reparentTasks(</span><br><span class="line">             mRootTaskInfo.token,</span><br><span class="line">             <span class="keyword">null</span> <span class="comment">/* newParent */</span>,</span><br><span class="line">             CONTROLLED_WINDOWING_MODES_WHEN_ACTIVE,</span><br><span class="line">             CONTROLLED_ACTIVITY_TYPES,</span><br><span class="line">             toTop);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>调用到了reparentTasks</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> WindowContainerTransaction <span class="title">reparentTasks</span><span class="params">(@Nullable WindowContainerToken currentParent,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable WindowContainerToken newParent, @Nullable <span class="keyword">int</span>[] windowingModes,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable <span class="keyword">int</span>[] activityTypes, <span class="keyword">boolean</span> onTop, <span class="keyword">boolean</span> reparentTopOnly)</span> </span>&#123;</span><br><span class="line">        mHierarchyOps.add(HierarchyOp.createForChildrenTasksReparent(</span><br><span class="line">                currentParent != <span class="keyword">null</span> ? currentParent.asBinder() : <span class="keyword">null</span>,</span><br><span class="line">                newParent != <span class="keyword">null</span> ? newParent.asBinder() : <span class="keyword">null</span>,</span><br><span class="line">                windowingModes,</span><br><span class="line">                activityTypes,</span><br><span class="line">                onTop,</span><br><span class="line">                reparentTopOnly));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//创建对应HIERARCHY_OP_TYPE_CHILDREN_TASKS_REPARENT的HierarchyOp</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HierarchyOp <span class="title">createForChildrenTasksReparent</span><span class="params">(IBinder currentParent,</span></span></span><br><span class="line"><span class="function"><span class="params">                IBinder newParent, <span class="keyword">int</span>[] windowingModes, <span class="keyword">int</span>[] activityTypes, <span class="keyword">boolean</span> onTop,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> reparentTopOnly)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> HierarchyOp.Builder(HIERARCHY_OP_TYPE_CHILDREN_TASKS_REPARENT)</span><br><span class="line">                    .setContainer(currentParent)</span><br><span class="line">                    .setReparentContainer(newParent)</span><br><span class="line">                    .setWindowingModes(windowingModes)</span><br><span class="line">                    .setActivityTypes(activityTypes)</span><br><span class="line">                    .setToTop(onTop)</span><br><span class="line">                    .setReparentTopOnly(reparentTopOnly)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="systemserver端的调用"><a href="#systemserver端的调用" class="headerlink" title="systemserver端的调用"></a>systemserver端的调用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/services/core/java/com/android/server/wm/WindowOrganizerController.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">applyHierarchyOp</span><span class="params">(WindowContainerTransaction.HierarchyOp hop, <span class="keyword">int</span> effects,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> syncId, @Nullable Transition transition, <span class="keyword">boolean</span> isInLockTaskMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CallerInfo caller, @Nullable IBinder errorCallbackToken,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable ITaskFragmentOrganizer organizer, @Nullable Transition finishTransition)</span> </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> HIERARCHY_OP_TYPE_CHILDREN_TASKS_REPARENT: &#123;</span><br><span class="line">            <span class="comment">//核心方法</span></span><br><span class="line">                effects |= reparentChildrenTasksHierarchyOp(hop, transition, syncId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">           	...</span><br><span class="line">            &#125;   </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">reparentChildrenTasksHierarchyOp</span><span class="params">(WindowContainerTransaction.HierarchyOp hop,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Transition transition, <span class="keyword">int</span> syncId)</span> </span>&#123;</span><br><span class="line">        WindowContainer&lt;?&gt; currentParent = hop.getContainer() != <span class="keyword">null</span></span><br><span class="line">                ? WindowContainer.fromBinder(hop.getContainer()) : <span class="keyword">null</span>;</span><br><span class="line">        WindowContainer newParent = hop.getNewParent() != <span class="keyword">null</span></span><br><span class="line">                ? WindowContainer.fromBinder(hop.getNewParent()) : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (currentParent == <span class="keyword">null</span> &amp;&amp; newParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newParent == <span class="keyword">null</span>) &#123;<span class="comment">//这里传递为null，所以给予没人的parent为DefaultTaskDisplayArea</span></span><br><span class="line">            newParent = currentParent.asTask().getDisplayContent().getDefaultTaskDisplayArea();</span><br><span class="line">        &#125;</span><br><span class="line">       ...</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;Task&gt; tasksToReparent = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="comment">//对当前的task节点下面所有children进行遍历</span></span><br><span class="line">        currentParent.forAllTasks(task -&gt; &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> reparent;</span><br><span class="line">            <span class="comment">//可能activitytype和windowmode不支持，就要直接返回不会放入tasksToReparent</span></span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.contains(hop.getActivityTypes(), task.getActivityType())</span><br><span class="line">                    || !ArrayUtils.contains(hop.getWindowingModes(), task.getWindowingMode())) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//如果放到顶部的就放到</span></span><br><span class="line">            <span class="keyword">if</span> (hop.getToTop()) &#123;</span><br><span class="line">                tasksToReparent.add(<span class="number">0</span>, task);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tasksToReparent.add(task);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> hop.getReparentTopOnly() &amp;&amp; tasksToReparent.size() == <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = tasksToReparent.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">            <span class="keyword">final</span> Task task = tasksToReparent.get(i);</span><br><span class="line">          ...</span><br><span class="line">          	<span class="comment">//newParent是TaskDisplayArea，即直接把原理挂在上下分屏的task挂到TaskDisplayArea下面</span></span><br><span class="line">            <span class="keyword">if</span> (newParent <span class="keyword">instanceof</span> TaskDisplayArea) &#123;</span><br><span class="line">                <span class="comment">// For now, reparenting to display area is different from other reparents...</span></span><br><span class="line">                task.reparent((TaskDisplayArea) newParent, hop.getToTop());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                task.reparent((Task) newParent,</span><br><span class="line">                        hop.getToTop() ? POSITION_TOP : POSITION_BOTTOM,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/*moveParents*/</span>, <span class="string">"processChildrenTaskReparentHierarchyOp"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRANSACT_EFFECTS_LIFECYCLE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>整个分屏结束核心流程结束，剩下的就是要进行相关resumeToActivity和ensureVisibleActivity等操作，触发生命周期的变化。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"><i class="fa fa-tag"></i> Android</a>
          
            <a href="/tags/%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81/" rel="tag"><i class="fa fa-tag"></i> 系统源码</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2023/09/20/FW%20WMS%E5%A4%9A%E5%B1%8F%E4%BA%92%E5%8A%A8%E5%8A%A8%E7%94%BB/" rel="next" title="Android 13 WMS多屏互动">
                <i class="fa fa-chevron-left"></i> Android 13 WMS多屏互动
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/09/21/FW%20freeform%E8%87%AA%E7%94%B1%E7%AA%97%E5%8F%A3/" rel="prev" title="Android 13 freeform自由窗口">
                Android 13 freeform自由窗口 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/timg.png"
                alt="WZKingdom" />
            
              <p class="site-author-name" itemprop="name">WZKingdom</p>
              <p class="site-description motion-element" itemprop="description">撸起袖子加油干！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#分屏启动"><span class="nav-number">1.</span> <span class="nav-text">分屏启动</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#桌面入口部分"><span class="nav-number">1.1.</span> <span class="nav-text">桌面入口部分</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemUI部分"><span class="nav-number">1.2.</span> <span class="nav-text">SystemUI部分</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemServer部分"><span class="nav-number">1.3.</span> <span class="nav-text">SystemServer部分</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分割线"><span class="nav-number">2.</span> <span class="nav-text">分割线</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#分割线创建"><span class="nav-number">2.1.</span> <span class="nav-text">分割线创建</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#寻找合适分割线"><span class="nav-number">2.2.</span> <span class="nav-text">寻找合适分割线</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#分割线拖动"><span class="nav-number">2.3.</span> <span class="nav-text">分割线拖动</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分屏退出"><span class="nav-number">3.</span> <span class="nav-text">分屏退出</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SystemUI端的调用"><span class="nav-number">3.1.</span> <span class="nav-text">SystemUI端的调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#systemserver端的调用"><span class="nav-number">3.2.</span> <span class="nav-text">systemserver端的调用</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WZKingdom</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">65.9k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/miku.model.json"},"display":{"position":"right","width":100,"height":200},"mobile":{"show":true},"log":false});</script></body>
</html>
